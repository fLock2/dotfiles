---
- name: Machine setup
  hosts: localhost
  become: false
  connection: local
  gather_facts: true
  vars:
    flyctl_version: "0.1.130"
    pulumi_version: "v3.94.2"

  tasks:
    - name: Get my user
      ansible.builtin.set_fact:
        remote_regular_user: "{{ansible_user_id}}"

    # - name: Add emacs-plus tap
    #   community.general.homebrew_tap:
    #     name: d12frosted/emacs-plus

    - name: Add yabai tap
      community.general.homebrew_tap:
        name: koekeishiya/formulae

    - name: install homebrew formulae packages
      become: false
      homebrew:
        name:
          - btop
          - cmake
          - eza
          - fd
          - fzf
          - gcc
          - git
          - helix
          - jq
          - gitui
          - libvterm
          - make
          - mas
          - mpv
          - neovim
          - nushell
          - ripgrep
          - starship
          - unzip
          - skhd
          - yabai
          - zellij
          - zoxide
        update_homebrew: yes
        state: present

    - name: install homebrew cask packages
      become: false
      homebrew_cask:
        name:
          # - arc
          - cheatsheet
          - discord
          - hiddenbar
          - iterm2
          - latest
          - mac-mouse-fix
          - nextcloud
          - notion
          - obsidian
          - raycast
          # - rectangle
          - shottr
          - wezterm
          - zen-browser
          - zotero
        state: present

    # - name: Check if emacs-plus alias is created
    #   stat:
    #     path: "/Applications/Emacs.app"
    #   register: emacsplus

    # - name: Create alias for emacs-plus in Applications folder
    #   shell: osascript -e 'tell application "Finder" to make alias file to posix file "/opt/homebrew/Cellar/emacs-plus@29/29.2/Emacs.app" at POSIX file "/Applications"'
    #   when:
    #     - emacsplus.stat.exists == false

    # - name: Check if Spacemacs is installed
    #   stat:
    #     path: "/Users/{{ remote_regular_user }}/.emacs.d/spacemacs.mk"
    #   register: spacemacs

    # - name: Check if emacs.d is present
    #   stat:
    #     path: "/Users/{{ remote_regular_user }}/.emacs.d"
    #   register: emacsd

    # - name: backup old .emacs.d
    #   ansible.builtin.copy:
    #     src: "/Users/{{ remote_regular_user }}/.emacs.d"
    #     dest: "/Users/{{ remote_regular_user }}/.emacs.d.bak"
    #     mode: "0755"
    #   when:
    #     - spacemacs.stat.exists == false
    #     - emacsd.stat.exists == true

    # - name: remove old .emacs.d
    #   ansible.builtin.file:
    #     path: "/Users/{{ remote_regular_user }}/.emacs.d"
    #     state: absent
    #   when:
    #     - spacemacs.stat.exists == false

    # - name: download Spacemacs
    #   ansible.builtin.git:
    #     repo: https://github.com/syl20bnr/spacemacs
    #     dest: "/Users/{{ remote_regular_user }}/.emacs.d"
    #   when:
    #     - spacemacs.stat.exists == false

    - name: check if cargo is installed
      shell: command -v cargo
      register: cargo_exists
      ignore_errors: yes

    - name: Download Rustup
      when: cargo_exists is failed
      get_url:
        url: https://sh.rustup.rs
        dest: /tmp/sh.rustup.rs
        mode: "0755"
        force: "yes"
      tags:
        - rust

    - name: install rust/cargo
      when: cargo_exists is failed
      shell: /tmp/sh.rustup.rs -y
      tags:
        - rust

    # - name: Install zoxide
    #   when:
    #   shell: cargo install --git https://github.com/ajeetdsouza/zoxide

    - name: install app store programs
      community.general.mas:
        id:
          - 975890633 # HotKey
          - 1352778147 # Bitwarden
          - 1355679052 # Dropover
          - 1451685025 # Wireguard
